<!DOCTYPE html>
<html lang>
  <head><meta name="generator" content="Hexo 3.9.0">
    
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,minimum-scale=1,maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">



  <meta name="description" content="Break Memcg Memory Limitation">




  <meta name="keywords" content="memcg,Linux,cgroup,docker,">





  <link rel="alternate" href="/default" title="THE Blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=1.1">



<link rel="canonical" href="http://blog.xiexun.tech/break-memcg.html">


<meta name="description" content="Environment linux kernel 5.3.6 4.19.67 (Debian)   docker 18.09.1 Debian 10.1  Kmem AccountingIn Linux kernel, kernel memory allocations (kmalloc, __alloc_pages_nodemask, etc.) will be accounted by mem">
<meta name="keywords" content="memcg,Linux,cgroup,docker">
<meta property="og:type" content="article">
<meta property="og:title" content="Break Memcg Memory Limitation">
<meta property="og:url" content="http://blog.xiexun.tech/break-memcg.html">
<meta property="og:site_name" content="THE Blog">
<meta property="og:description" content="Environment linux kernel 5.3.6 4.19.67 (Debian)   docker 18.09.1 Debian 10.1  Kmem AccountingIn Linux kernel, kernel memory allocations (kmalloc, __alloc_pages_nodemask, etc.) will be accounted by mem">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://blog.xiexun.tech/img/one_task_mem.png">
<meta property="og:image" content="http://blog.xiexun.tech/img/alloc_mem_top.png">
<meta property="og:image" content="http://blog.xiexun.tech/img/alloc_task_killed.png">
<meta property="og:image" content="http://blog.xiexun.tech/img/host_shell_killed.png">
<meta property="og:updated_time" content="2020-01-11T09:11:09.345Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Break Memcg Memory Limitation">
<meta name="twitter:description" content="Environment linux kernel 5.3.6 4.19.67 (Debian)   docker 18.09.1 Debian 10.1  Kmem AccountingIn Linux kernel, kernel memory allocations (kmalloc, __alloc_pages_nodemask, etc.) will be accounted by mem">
<meta name="twitter:image" content="http://blog.xiexun.tech/img/one_task_mem.png">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1">
<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">





<script type="text/javascript">
  var themeConfig = {
    fancybox: {
      enable: false
    },
  };
</script>




  



    <title> Break Memcg Memory Limitation - THE Blog </title>
  </head>

  <body>
    <div id="page">
      <header id="masthead"><div class="site-header-inner">
    <h1 class="site-title">
        <a href="/." class="logo">THE Blog</a>
    </h1>

    <nav id="nav-top">
        
            <ul id="menu-top" class="nav-top-items">
                
                    <li class="menu-item">
                        <a href="/archives">
                            
                            
                                Archives
                            
                        </a>
                    </li>
                
            </ul>
        
  </nav>
</div>

      </header>
      <div id="content">
        
    <div id="primary">
        
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          Break Memcg Memory Limitation
        
      </h1>

      <time class="post-time">
          Jan 11 2020
      </time>
    </header>



    
            <div class="post-content">
            <h1 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h1><ul>
<li>linux kernel<ul>
<li>5.3.6</li>
<li>4.19.67 (Debian)</li>
</ul>
</li>
<li>docker 18.09.1</li>
<li>Debian 10.1</li>
</ul>
<h1 id="Kmem-Accounting"><a href="#Kmem-Accounting" class="headerlink" title="Kmem Accounting"></a>Kmem Accounting</h1><p>In Linux kernel, kernel memory allocations (<code>kmalloc</code>, <code>__alloc_pages_nodemask</code>, etc.) will be accounted by memcg if <code>__GFP_ACCOUNT</code> flag is set.</p>
<h1 id="Per-CPU-Allocations"><a href="#Per-CPU-Allocations" class="headerlink" title="Per-CPU Allocations"></a>Per-CPU Allocations</h1><p>In Linux kernel, per-CPU memory is allocated by <a href="https://elixir.bootlin.com/linux/v5.3.6/source/mm/percpu.c#L1586" target="_blank" rel="noopener"><code>pcpu_alloc</code></a>. <code>pcpu_alloc</code> creates its own memory pool, which is not accounted by memcg.</p>
<h1 id="seccomp-syscall"><a href="#seccomp-syscall" class="headerlink" title="seccomp syscall"></a><code>seccomp</code> syscall</h1><p>We can use <code>seccomp</code> syscall to set Berkerly Packet Filter (BPF). While setting BPF, kernel will <a href="https://elixir.bootlin.com/linux/v5.3.6/source/kernel/bpf/core.c#L114" target="_blank" rel="noopener">allocate per-CPU memory</a> and will <a href="https://elixir.bootlin.com/linux/v5.3.6/source/kernel/bpf/core.c#L77" target="_blank" rel="noopener">allocate memory without <code>__GFP_ACCOUNT</code></a>. By setting BPF for many times, we can allocate much memory without memcg accounting.</p>
<h1 id="Test-on-Docker"><a href="#Test-on-Docker" class="headerlink" title="Test on Docker"></a>Test on Docker</h1><h2 id="Host"><a href="#Host" class="headerlink" title="Host"></a>Host</h2><p>Host machine is Debian 10 on QEMU, with 1GB memory.</p>
<h2 id="run-a-docker-container-with-memory-limitations"><a href="#run-a-docker-container-with-memory-limitations" class="headerlink" title="run a docker container with memory limitations"></a>run a docker container with memory limitations</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name debian --memory 100000000 --kernel-memory 50000000 debian:slim /bin/bash</span><br></pre></td></tr></table></figure>

<p>Run a Debian container with 100MB memory limitation and 50MB kernel memory limitation.</p>
<h2 id="write-program-to-set-BPF"><a href="#write-program-to-set-BPF" class="headerlink" title="write program to set BPF"></a>write program to set BPF</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">    prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;bpf);</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>I find that a task can allocate up to tens of MBs, and memcg only accounts several hundreds of KBs of them.<br><img src="/img/one_task_mem.png" alt="one task mem"></p>
<h2 id="run-enough-tasks-to-allocate-almost-all-memory"><a href="#run-enough-tasks-to-allocate-almost-all-memory" class="headerlink" title="run enough tasks to allocate almost all memory"></a>run enough tasks to allocate almost all memory</h2><p>I run 64 tasks here and allocate almost all memory (total memory is 1GB).<br><img src="/img/alloc_mem_top.png" alt="alloc mem top"></p>
<h2 id="result"><a href="#result" class="headerlink" title="result"></a>result</h2><p>OOM killer try to kill tasks, some of my allocating tasks are killed.<br><img src="/img/alloc_task_killed.png" alt="alloc task killed"><br>Finally the host shell is killed because of out of memory.<br><img src="/img/host_shell_killed.png" alt="host shell killed"></p>
<h1 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h1><h2 id="user-space-program-that-allocates-per-CPU-memory"><a href="#user-space-program-that-allocates-per-CPU-memory" class="headerlink" title="user-space program that allocates per-CPU memory"></a>user-space program that allocates per-CPU memory</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/filter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/audit.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> <span class="title">insns</span>[] =</span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">     &#123;</span><br><span class="line">      .code = <span class="number">0x6</span>,</span><br><span class="line">      .jt = <span class="number">0</span>,</span><br><span class="line">      .jf = <span class="number">0</span>,</span><br><span class="line">      .k = SECCOMP_RET_ALLOW</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span> <span class="title">bpf</span> =</span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">   .len = <span class="number">1</span>,</span><br><span class="line">   .filter = insns</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">int</span> ret;</span><br><span class="line">  </span><br><span class="line">  ret = prctl(PR_SET_NO_NEW_PRIVS, <span class="number">1</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (ret)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"error1 %d\n"</span>, errno);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      ret = prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;bpf);</span><br><span class="line">      <span class="keyword">if</span> (ret)</span><br><span class="line">        &#123;</span><br><span class="line">          sleep(<span class="number">1</span>);</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"error %d\n"</span>, errno);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          count++;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"ok %d\n"</span>, count);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


            </div>
          

    
      <footer class="post-footer">
		
		<div class="post-tags">
		  
			<a href="/tags/memcg/">memcg</a>
		  
			<a href="/tags/Linux/">Linux</a>
		  
			<a href="/tags/cgroup/">cgroup</a>
		  
			<a href="/tags/docker/">docker</a>
		  
		</div>
		

        
        
  <nav class="post-nav">
    
    
      <a class="next" href="/compile-linux-llvm.html">
        <span class="next-text nav-default">Compile Linux Kernel to LLVM Bitcode</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

        
  <div class="comments" id="comments">
    
  </div>


      </footer>
    
  </article>

    </div>

      </div>

      <footer id="colophon"><span class="copyright-year">
    
        &copy;
    
        2019 -
    
    2020
    <span class="footer-author">Xie Xun.</span>
    <span class="power-by">
        Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a> and <a class="theme-link" href="https://github.com/frostfan/hexo-theme-polarbear">Polar Bear</a>.
    </span>
    <span>
        Except where otherwise noted, content on this site is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
    </span>
</span>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>
    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  

    <script type="text/javascript" src="/js/src/theme.js?v=1.1"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=1.1"></script>

  </body>
</html>
